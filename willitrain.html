<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Will It Rain?</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* === Design Tokens === */
        :root {
            --color-bg:         #F7F8FC;
            --color-surface:    #FFFFFF;
            --color-surface-2:  #EEF0F8;
            --color-primary:    #6B6FC5;
            --color-primary-dk: #5558A8;
            --color-primary-lt: #E8E9F7;
            --color-text:       #2E2E48;
            --color-text-sub:   #7E7EA0;
            --color-text-faint: #BCBCDA;
            --color-border:     #E2E4F0;
            --color-error:      #C0506A;

            --rain-clear:  #E8F5E9;
            --rain-low:    #C8DCF5;
            --rain-mid:    #7BAEE0;
            --rain-high:   #4672B0;
            --rain-sure:   #2C4A8A;

            --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;

            --radius-sm:   8px;
            --radius-md:   14px;
            --radius-lg:   20px;
            --radius-full: 999px;

            --shadow-sm: 0 1px 4px rgba(107,111,197,0.08);
            --shadow-md: 0 4px 16px rgba(107,111,197,0.12);
            --shadow-lg: 0 8px 32px rgba(107,111,197,0.16);
        }

        /* === Reset === */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font);
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            min-height: 100dvh;
            -webkit-font-smoothing: antialiased;
        }

        .hidden {
            display: none !important;
        }

        /* === Screen & Shell === */
        .screen {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(160deg, #F0F2FA 0%, #F7F8FC 50%, #EEF0FB 100%);
        }

        .app-shell {
            width: 100%;
            max-width: 480px;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            flex: 1;
        }

        .app-shell.center-content {
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 1rem;
        }

        /* === Brand === */
        .brand {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            margin-top: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .brand-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-primary);
            letter-spacing: -0.02em;
        }

        .brand-sub {
            font-size: 0.875rem;
            color: var(--color-text-sub);
            font-weight: 400;
            text-align: center;
            line-height: 1.4;
        }

        /* === Form Fields === */
        .ask-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .field-label {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-text-faint);
            padding-left: 0.25rem;
        }

        .text-field {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            font-family: var(--font);
            font-weight: 400;
            color: var(--color-text);
            background: var(--color-surface);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-md);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .text-field::placeholder {
            color: var(--color-text-faint);
            font-weight: 300;
        }

        .text-field:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(107,111,197,0.12);
        }

        /* === Buttons === */
        .primary-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            font-family: var(--font);
            font-weight: 500;
            color: #ffffff;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            letter-spacing: 0.02em;
            box-shadow: var(--shadow-md);
            transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
            -webkit-appearance: none;
            margin-top: 0.25rem;
        }

        .primary-btn:hover {
            background: var(--color-primary-dk);
            box-shadow: var(--shadow-lg);
        }

        .primary-btn:active {
            transform: scale(0.97);
        }

        .ghost-btn {
            background: transparent;
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-sub);
            font-family: var(--font);
            font-size: 0.8rem;
            padding: 0.35rem 0.9rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
            white-space: nowrap;
            -webkit-appearance: none;
        }

        .ghost-btn:hover {
            background: var(--color-primary-lt);
            color: var(--color-primary);
            border-color: transparent;
        }

        /* === Inline Error === */
        .inline-error {
            font-size: 0.85rem;
            color: var(--color-error);
            text-align: center;
            line-height: 1.4;
            padding: 0 0.25rem;
        }

        /* === Loading === */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--color-text-sub);
        }

        /* === Results Header === */
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1.5rem;
        }

        .result-location-name {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-text);
        }

        /* === Answer Card === */
        .answer-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 2rem 1.5rem 1.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
            text-align: center;
            border-top: 3px solid var(--color-border);
            transition: border-color 0.4s ease;
        }

        .answer-pct {
            font-size: 4.5rem;
            font-weight: 300;
            letter-spacing: -0.04em;
            color: var(--color-primary);
            line-height: 1;
            transition: color 0.4s ease;
        }

        .answer-verdict {
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-text);
            line-height: 1.4;
            max-width: 260px;
        }

        .answer-datetime {
            font-size: 0.8rem;
            color: var(--color-text-faint);
            font-weight: 400;
            margin-top: 0.25rem;
        }

        /* === Uncertainty Disclaimer === */
        .uncertainty-note {
            font-size: 0.8rem;
            color: var(--color-text-sub);
            text-align: center;
            line-height: 1.5;
            padding: 0.75rem 1rem;
            background: var(--color-surface-2);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--color-primary);
        }

        /* === Context Window === */
        .context-label {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-text-faint);
        }

        .context-strip {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .context-slot {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
            padding: 0.75rem 0.25rem;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            border: 1.5px solid var(--color-border);
            transition: background 0.2s, border-color 0.2s;
        }

        .context-slot.context-slot-active {
            background: var(--color-primary-lt);
            border-color: var(--color-primary);
        }

        .context-slot-time {
            font-size: 0.7rem;
            color: var(--color-text-faint);
            font-weight: 500;
        }

        .context-slot.context-slot-active .context-slot-time {
            color: var(--color-primary);
        }

        .context-slot-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .context-slot-pct {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-sub);
        }

        .context-slot.context-slot-active .context-slot-pct {
            color: var(--color-primary);
        }

        /* === Error Screen === */
        .error-icon {
            font-size: 2.5rem;
        }

        .error-text {
            font-size: 1rem;
            color: var(--color-text-sub);
            line-height: 1.5;
            max-width: 280px;
        }

        /* === Data Credit === */
        .data-credit {
            font-size: 0.7rem;
            color: var(--color-text-faint);
            text-align: center;
            margin-top: auto;
            padding-bottom: 1.5rem;
        }

        .data-credit a {
            color: var(--color-text-faint);
            text-decoration: none;
        }

        .back-home {
            font-size: 0.8rem;
            color: var(--color-text-faint);
            text-decoration: none;
            text-align: center;
            margin-top: auto;
            padding-bottom: 1.5rem;
            display: block;
        }

        .back-home:hover {
            color: var(--color-primary);
        }
    </style>
</head>
<body>

    <!-- SCREEN 1: Ask -->
    <div id="screen-ask" class="screen">
        <div class="app-shell">
            <div class="brand">
                <h1 class="brand-title">Will It Rain?</h1>
                <p class="brand-sub">Enter a zip code, date, and time<br>to check the rain forecast.</p>
            </div>

            <div class="ask-form">
                <div class="field-group">
                    <label class="field-label" for="zip-input">Zip Code</label>
                    <input
                        id="zip-input"
                        type="tel"
                        inputmode="numeric"
                        maxlength="5"
                        placeholder="e.g. 90210"
                        autocomplete="postal-code"
                        class="text-field"
                    />
                </div>

                <div class="field-group">
                    <label class="field-label" for="date-input">Date</label>
                    <input
                        id="date-input"
                        type="text"
                        placeholder="e.g. today, tomorrow, Monday, Feb 25"
                        autocomplete="off"
                        class="text-field"
                    />
                </div>

                <div class="field-group">
                    <label class="field-label" for="time-input">Time</label>
                    <input
                        id="time-input"
                        type="text"
                        placeholder="e.g. 3pm, noon, 8 in the morning"
                        autocomplete="off"
                        class="text-field"
                    />
                </div>

                <p id="ask-error" class="inline-error hidden"></p>

                <button id="ask-submit" class="primary-btn">Will it rain?</button>
            </div>

            <a href="index.html" class="back-home">Back to Home</a>
        </div>
    </div>

    <!-- SCREEN 2: Loading -->
    <div id="screen-loading" class="screen hidden">
        <div class="app-shell center-content">
            <div class="spinner"></div>
            <p class="loading-text">Checking the clouds&#8230;</p>
        </div>
    </div>

    <!-- SCREEN 3: Answer -->
    <div id="screen-answer" class="screen hidden">
        <div class="app-shell">

            <div class="results-header">
                <p id="answer-location" class="result-location-name"></p>
                <button id="ask-again-btn" class="ghost-btn">Ask again</button>
            </div>

            <div id="answer-card" class="answer-card">
                <div id="answer-pct" class="answer-pct"></div>
                <div id="answer-verdict" class="answer-verdict"></div>
                <div id="answer-datetime" class="answer-datetime"></div>
            </div>

            <p id="uncertainty-note" class="uncertainty-note hidden">
                Forecasts more than a week out have a higher degree of uncertainty and are likely to change.
            </p>

            <p class="context-label">Around that time</p>
            <div id="context-strip" class="context-strip"></div>

            <p class="data-credit">Forecast: <a href="https://open-meteo.com" target="_blank">Open-Meteo</a> &middot; Location: <a href="https://zippopotam.us" target="_blank">Zippopotam</a></p>
        </div>
    </div>

    <!-- SCREEN 4: Error -->
    <div id="screen-error" class="screen hidden">
        <div class="app-shell center-content">
            <div class="error-icon">&#9729;</div>
            <p id="error-message" class="error-text"></p>
            <button id="error-retry-btn" class="primary-btn">Try again</button>
        </div>
    </div>

    <script>
        // === State ===
        var appState = {
            zip: '',
            cityName: '',
            lat: null,
            lon: null,
            hourlyTimes: [],
            hourlyProbs: [],
            parsedDate: '',
            parsedHour: null,
            displayDateTime: '',
            isBeyondWeek: false
        };

        // === Screen Navigation ===
        function showScreen(id) {
            var screens = ['screen-ask', 'screen-loading', 'screen-answer', 'screen-error'];
            for (var i = 0; i < screens.length; i++) {
                document.getElementById(screens[i]).classList.add('hidden');
            }
            document.getElementById(id).classList.remove('hidden');
        }

        // === Utilities ===
        function roundToTen(n) {
            return Math.round(n / 10) * 10;
        }

        function isValidZip(zip) {
            return /^\d{5}$/.test(zip);
        }

        function rainColor(pct) {
            if (pct <= 10) return '#E8F5E9';
            if (pct <= 30) return '#C8DCF5';
            if (pct <= 60) return '#7BAEE0';
            if (pct <= 80) return '#4672B0';
            return '#2C4A8A';
        }

        function rainVerdict(pct) {
            if (pct <= 10) return 'Little to no chance of rain';
            if (pct <= 30) return 'Low chance of rain, but keep an eye out';
            if (pct <= 50) return 'Rain is possible, you will want to keep an eye on the forecast';
            if (pct <= 70) return 'Rain is likely, you will want to watch for updates';
            if (pct <= 90) return 'Rain is very likely';
            return 'Rain is almost certain';
        }

        // === Date Parsing ===
        function getTodayDate() {
            var d = new Date();
            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        }

        function dateToStr(d) {
            var y = d.getFullYear();
            var m = String(d.getMonth() + 1).padStart ? String(d.getMonth() + 1).padStart(2, '0') : (d.getMonth() + 1 < 10 ? '0' + (d.getMonth() + 1) : String(d.getMonth() + 1));
            var day = d.getDate() < 10 ? '0' + d.getDate() : String(d.getDate());
            return y + '-' + m + '-' + day;
        }

        function parseDateInput(str) {
            var s = str.trim().toLowerCase();
            var today = getTodayDate();

            if (s === 'today' || s === 'tonight') {
                return dateToStr(today);
            }

            if (s === 'tomorrow') {
                var tom = new Date(today);
                tom.setDate(tom.getDate() + 1);
                return dateToStr(tom);
            }

            // Day names
            var dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
            for (var di = 0; di < dayNames.length; di++) {
                if (s === dayNames[di] || s === dayNames[di].substring(0, 3)) {
                    var target = new Date(today);
                    var todayDow = today.getDay();
                    var diff = di - todayDow;
                    if (diff <= 0) diff += 7;
                    target.setDate(target.getDate() + diff);
                    return dateToStr(target);
                }
            }

            // Month name formats: "Feb 25", "February 25", "feb 25"
            var monthNames = ['january','february','march','april','may','june','july','august','september','october','november','december'];
            var monthShort = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
            for (var mi = 0; mi < monthNames.length; mi++) {
                var fullName = monthNames[mi];
                var shortName = monthShort[mi];
                if (s.indexOf(fullName) === 0 || s.indexOf(shortName) === 0) {
                    var rest = s.replace(fullName, '').replace(shortName, '').trim();
                    var dayNum = parseInt(rest, 10);
                    if (!isNaN(dayNum) && dayNum >= 1 && dayNum <= 31) {
                        // Find the next occurrence of this month/day
                        var candidate = new Date(today.getFullYear(), mi, dayNum);
                        if (candidate < today) {
                            candidate = new Date(today.getFullYear() + 1, mi, dayNum);
                        }
                        return dateToStr(candidate);
                    }
                }
            }

            // Numeric: "2/25" or "2-25"
            var slashMatch = s.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
            if (slashMatch) {
                var mo = parseInt(slashMatch[1], 10) - 1;
                var da = parseInt(slashMatch[2], 10);
                var cand = new Date(today.getFullYear(), mo, da);
                if (cand < today) {
                    cand = new Date(today.getFullYear() + 1, mo, da);
                }
                return dateToStr(cand);
            }

            // ISO: "2026-02-25"
            var isoMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (isoMatch) {
                return isoMatch[1] + '-' + isoMatch[2] + '-' + isoMatch[3];
            }

            return null;
        }

        // === Time Parsing ===
        function parseTimeInput(str) {
            var s = str.trim().toLowerCase();

            if (s === 'noon' || s === '12pm' || s === '12 pm') return 12;
            if (s === 'midnight' || s === '12am' || s === '12 am') return 0;

            // "8 in the morning" / "8 this morning"
            if (s.indexOf('morning') !== -1 || s.indexOf('am') !== -1 || s.indexOf('a.m.') !== -1) {
                var h = parseInt(s, 10);
                if (!isNaN(h) && h >= 1 && h <= 12) {
                    return h === 12 ? 0 : h;
                }
            }

            // "8 at night" / "8 tonight" / "8 in the evening"
            if (s.indexOf('night') !== -1 || s.indexOf('tonight') !== -1 || s.indexOf('evening') !== -1 || s.indexOf('pm') !== -1 || s.indexOf('p.m.') !== -1 || s.indexOf('afternoon') !== -1) {
                var hp = parseInt(s, 10);
                if (!isNaN(hp) && hp >= 1 && hp <= 12) {
                    return hp === 12 ? 12 : hp + 12;
                }
            }

            // "15:00" or "15"
            var colonMatch = s.match(/^(\d{1,2})(?::(\d{2}))?$/);
            if (colonMatch) {
                var hr = parseInt(colonMatch[1], 10);
                if (hr >= 0 && hr <= 23) return hr;
            }

            return null;
        }

        // === Display Formatting ===
        function formatDisplayDateTime(dateStr, hour) {
            var parts = dateStr.split('-');
            var d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
            var dowNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            var monNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var dow = dowNames[d.getDay()];
            var mon = monNames[d.getMonth()];
            var day = d.getDate();

            var ampm = hour >= 12 ? 'pm' : 'am';
            var display = hour % 12 || 12;

            return dow + ', ' + mon + ' ' + day + ' at ' + display + ampm;
        }

        function formatHourLabel(hour) {
            var ampm = hour >= 12 ? 'pm' : 'am';
            var h = hour % 12 || 12;
            return h + ampm;
        }

        // === Find hourly index ===
        function findHourIndex(dateStr, hour) {
            var target = dateStr + 'T' + (hour < 10 ? '0' + hour : hour) + ':00';
            for (var i = 0; i < appState.hourlyTimes.length; i++) {
                if (appState.hourlyTimes[i] === target) return i;
            }
            return -1;
        }

        // === Days between two date strings ===
        function daysBetween(dateStr1, dateStr2) {
            var p1 = dateStr1.split('-');
            var p2 = dateStr2.split('-');
            var d1 = new Date(parseInt(p1[0],10), parseInt(p1[1],10)-1, parseInt(p1[2],10));
            var d2 = new Date(parseInt(p2[0],10), parseInt(p2[1],10)-1, parseInt(p2[2],10));
            return Math.round((d2 - d1) / 86400000);
        }

        // === API Calls ===
        function geocodeZip(zip, onSuccess, onError) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://api.zippopotam.us/us/' + zip, true);
            xhr.timeout = 8000;
            xhr.onload = function() {
                if (xhr.status === 404) {
                    onError('That zip code was not found. Please try another.');
                    return;
                }
                if (xhr.status !== 200) {
                    onError('Could not look up that zip code. Please try again.');
                    return;
                }
                var data;
                try { data = JSON.parse(xhr.responseText); } catch(e) {
                    onError('Could not read the location data. Please try again.');
                    return;
                }
                var place = data['places'][0];
                onSuccess({
                    city:  place['place name'],
                    state: place['state abbreviation'],
                    lat:   parseFloat(place['latitude']),
                    lon:   parseFloat(place['longitude'])
                });
            };
            xhr.onerror   = function() { onError('Network error. Please check your connection.'); };
            xhr.ontimeout = function() { onError('The request timed out. Please try again.'); };
            xhr.send();
        }

        function fetchForecast(lat, lon, onSuccess, onError) {
            var url = 'https://api.open-meteo.com/v1/forecast'
                + '?latitude='  + lat
                + '&longitude=' + lon
                + '&hourly=precipitation_probability'
                + '&timezone=auto'
                + '&forecast_days=16';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.timeout = 10000;
            xhr.onload = function() {
                if (xhr.status !== 200) {
                    onError('Could not fetch the forecast. Please try again.');
                    return;
                }
                var data;
                try { data = JSON.parse(xhr.responseText); } catch(e) {
                    onError('Could not read forecast data. Please try again.');
                    return;
                }
                onSuccess({
                    times: data.hourly.time,
                    probs: data.hourly.precipitation_probability
                });
            };
            xhr.onerror   = function() { onError('Network error. Please check your connection.'); };
            xhr.ontimeout = function() { onError('The forecast request timed out. Please try again.'); };
            xhr.send();
        }

        // === Render Answer ===
        function renderAnswer() {
            var idx = findHourIndex(appState.parsedDate, appState.parsedHour);

            if (idx === -1) {
                document.getElementById('error-message').textContent = 'We couldn\'t find forecast data for that date and time.';
                showScreen('screen-error');
                return;
            }

            var rawPct = appState.hourlyProbs[idx];
            var pct = roundToTen(rawPct);

            // Answer card
            var color = rainColor(pct);
            var pctEl    = document.getElementById('answer-pct');
            var verdictEl = document.getElementById('answer-verdict');
            var dtEl     = document.getElementById('answer-datetime');
            var cardEl   = document.getElementById('answer-card');

            pctEl.textContent    = pct + '%';
            verdictEl.textContent = rainVerdict(pct);
            dtEl.textContent     = appState.displayDateTime;
            pctEl.style.color    = color;
            cardEl.style.borderTopColor = color;

            // Location
            document.getElementById('answer-location').textContent = appState.cityName;

            // Uncertainty note
            var noteEl = document.getElementById('uncertainty-note');
            if (appState.isBeyondWeek) {
                noteEl.classList.remove('hidden');
            } else {
                noteEl.classList.add('hidden');
            }

            // Context strip (Â±2 hours, clamped to available data)
            var strip = document.getElementById('context-strip');
            strip.innerHTML = '';

            for (var offset = -2; offset <= 2; offset++) {
                var ctxIdx = idx + offset;
                if (ctxIdx < 0 || ctxIdx >= appState.hourlyTimes.length) continue;

                // Make sure this context slot is on the same day
                var ctxDate = appState.hourlyTimes[ctxIdx].substring(0, 10);
                if (ctxDate !== appState.parsedDate) continue;

                var ctxHour = parseInt(appState.hourlyTimes[ctxIdx].substring(11, 13), 10);
                var ctxRaw  = appState.hourlyProbs[ctxIdx];
                var ctxPct  = roundToTen(ctxRaw);
                var ctxColor = rainColor(ctxPct);
                var isActive = (offset === 0);

                var slot = document.createElement('div');
                slot.className = 'context-slot' + (isActive ? ' context-slot-active' : '');

                var timeEl = document.createElement('span');
                timeEl.className = 'context-slot-time';
                timeEl.textContent = formatHourLabel(ctxHour);

                var dot = document.createElement('span');
                dot.className = 'context-slot-dot';
                dot.style.background = ctxColor;

                var pctLabel = document.createElement('span');
                pctLabel.className = 'context-slot-pct';
                pctLabel.textContent = ctxPct + '%';

                slot.appendChild(timeEl);
                slot.appendChild(dot);
                slot.appendChild(pctLabel);
                strip.appendChild(slot);
            }

            showScreen('screen-answer');
        }

        // === Main Flow ===
        function loadForecast() {
            var zip      = document.getElementById('zip-input').value.trim();
            var dateStr  = document.getElementById('date-input').value.trim();
            var timeStr  = document.getElementById('time-input').value.trim();
            var errorEl  = document.getElementById('ask-error');

            // Validate zip
            if (!isValidZip(zip)) {
                errorEl.textContent = 'Please enter a valid 5-digit US zip code.';
                errorEl.classList.remove('hidden');
                document.getElementById('zip-input').focus();
                return;
            }

            // Parse date
            var parsedDate = parseDateInput(dateStr);
            if (!parsedDate) {
                errorEl.textContent = 'We couldn\'t understand that date \u2014 try \u201ctomorrow\u201d, \u201cMonday\u201d, or \u201c2/25\u201d.';
                errorEl.classList.remove('hidden');
                document.getElementById('date-input').focus();
                return;
            }

            // Parse time
            var parsedHour = parseTimeInput(timeStr);
            if (parsedHour === null) {
                errorEl.textContent = 'We couldn\'t understand that time \u2014 try \u201c3pm\u201d, \u201cnoon\u201d, or \u201c8 in the morning\u201d.';
                errorEl.classList.remove('hidden');
                document.getElementById('time-input').focus();
                return;
            }

            // Check date range
            var todayStr = dateToStr(getTodayDate());
            var daysOut = daysBetween(todayStr, parsedDate);

            if (daysOut < 0) {
                errorEl.textContent = 'That date is in the past. Please enter a future date.';
                errorEl.classList.remove('hidden');
                document.getElementById('date-input').focus();
                return;
            }

            if (daysOut > 16) {
                errorEl.textContent = 'We don\'t have forecasts that far out \u2014 try a date within the next two weeks.';
                errorEl.classList.remove('hidden');
                document.getElementById('date-input').focus();
                return;
            }

            errorEl.classList.add('hidden');

            // Save state
            appState.zip             = zip;
            appState.parsedDate      = parsedDate;
            appState.parsedHour      = parsedHour;
            appState.isBeyondWeek    = (daysOut > 7);
            appState.displayDateTime = formatDisplayDateTime(parsedDate, parsedHour);

            showScreen('screen-loading');

            geocodeZip(zip, function(geo) {
                appState.cityName = geo.city + ', ' + geo.state;
                appState.lat = geo.lat;
                appState.lon = geo.lon;

                fetchForecast(geo.lat, geo.lon, function(forecast) {
                    appState.hourlyTimes = forecast.times;
                    appState.hourlyProbs = forecast.probs;
                    renderAnswer();
                }, function(errMsg) {
                    document.getElementById('error-message').textContent = errMsg;
                    showScreen('screen-error');
                });

            }, function(errMsg) {
                document.getElementById('error-message').textContent = errMsg;
                showScreen('screen-error');
            });
        }

        // === Event Listeners ===
        document.getElementById('ask-submit').addEventListener('click', function() {
            loadForecast();
        });

        document.getElementById('zip-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                document.getElementById('date-input').focus();
            }
        });

        document.getElementById('date-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                document.getElementById('time-input').focus();
            }
        });

        document.getElementById('time-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                loadForecast();
            }
        });

        // Clear error on any input change
        var inputs = ['zip-input', 'date-input', 'time-input'];
        for (var ii = 0; ii < inputs.length; ii++) {
            (function(inputId) {
                document.getElementById(inputId).addEventListener('input', function() {
                    document.getElementById('ask-error').classList.add('hidden');
                });
            })(inputs[ii]);
        }

        document.getElementById('ask-again-btn').addEventListener('click', function() {
            document.getElementById('zip-input').value = appState.zip;
            showScreen('screen-ask');
        });

        document.getElementById('error-retry-btn').addEventListener('click', function() {
            showScreen('screen-ask');
        });
    </script>
</body>
</html>
